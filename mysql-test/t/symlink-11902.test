#
# MDEV-11902 mi_open race condition
#
source include/have_debug_sync.inc;
source include/have_symlink.inc;
source include/not_windows.inc;
call mtr.add_suppression("File.*t1.* not found");

create table mysql.t1 (a int, b char(16));
insert mysql.t1 values (100, 'test');

system mkdir $MYSQLTEST_VARDIR/tmp/foo;
replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR;
eval create table t1 (a int, b char(16))
                      data directory="$MYSQLTEST_VARDIR/tmp/foo";
insert t1 values (200, 'some');
select * from t1;
flush tables;
set debug_sync='mi_open_datafile WAIT_FOR go';
send select * from t1;
connect con1, localhost, root;
let $datadir=`select @@datadir`;
system rm -rf $MYSQLTEST_VARDIR/tmp/foo;
system ln -s $datadir/mysql $MYSQLTEST_VARDIR/tmp/foo;
set debug_sync='now SIGNAL go';
connection default;
replace_regex / '.*\/tmp\// 'MYSQLTEST_VARDIR\/tmp\// /31/20/;
error 29;
reap;
flush tables;
drop table if exists mysql.t1, t1;
set debug_sync='RESET';
system rm -rf $MYSQLTEST_VARDIR/tmp/foo;
